# **Руководство по использованию библиотеки `discord-py`**
### *Здесь вы можете почитать об основах, которые необходимо понимать, чтобы грамотно работать с библиотекой и не задавать вопросов, касающихся самых базовых вещей*
___

Вероятнее всего у вас уже имеется созданный бот, поэтому инструкция по его созданию будет пропущена *(но, возмжно появится позже)*.

## Прежде чем начать...

Прежде чем приступать к работе с ботом, я сразу рекомендую зайти на страницу вашего бота и включить **намерения** (`intents`, [**подробнее**][4]). Для этого зайдите в [раздел приложений][1] и выберите вашего бота. Затем, слева, на вкладке **`"Bot"`**

[![Бот][2]][2] 

Включите параметры `PRESENCE INTENT` и `SERVER MEMBERS INTENT`

[![введите сюда описание изображения][3]][3]

Намерения нужны для работы с некоторыми событиями, объектами пользователей серверов (`участник`/`member`) и др. Они вам точно понадобятся, поэтому лучше включить их сразу, чтобы потом не спрашивать, почему вам не удается получить данные о пользователе сервера или чего-либо еще.

---

## Начало работы с ботом и `discord-py`

Бот, которого вы создали на странице [приложений][9], является аккаунтом дискорда, который по сути является таким же пользовательским аккаунтом, как и ваш, но с атрибутом `bot` и некоторыми ограничениями. Чтобы бот начал что-то делать, нужно создать его в коде и прописать логику.

Для начала рассмотрим виды ботов, которые предоставляет библиотека:

- [`discord.Client`][5] - фактически, самый базовый бот, на котором основаны другие. Умеет обрабатывать события по типу получения сообщений `on_message()`, установки реакции `on_raw_reaction_add()` и [другие][6].
- [`discord.ext.commands.Bot`][7] - тот же `discord.Client`, только умеет находить в сообщениях и обрабатывать отдельные команды, которые начинаются с какого-либо префикса, например `!test`
- [`discord.ext.commands.Cog`][8] - про этого бота ничего сказать не могу, так как ни разу не использовал. Насколько мне известно, он нужен в тех случаях, когда вы планируете задать боту кучу разных комманд, событий и организовать все это в один отдельный класс.

В общем-то, выбор бота зависит напрямую от цели использования. Если вам нужен простой бот, который будет читать чат, фильтровать мат и т.п., считывать реакции, выдавать роли при входе нового пользователя и т.д., то вам хватит базового бота [`discord.Client`][5].

Если помимо того, что я написал выше, вы хотите **добавить еще** и обработку команд по типу `!ban <@User>`, `!play <Ссылка на видео с YouTube>`, `!погода` и т.п., то использовать надо именно  [`discord.ext.commands.Bot`][7].

---

## Пишем код

Теперь, когда вы определились с ботом можно наконец-то приступить к написанию кода.

Для начала подключим библиотеку.
```py
import discord
```

**На данном этапе я настоятельно рекомендую ознакомиться с [руководством по использованию документации][10], так как на эту самую документацию я буду ссылаться очень часто и без ее использования вы вряд ли напишете что-то самостоятельно и будете постоянно спрашивать как реализовать ту или иную функцию.**

В случае, если вы хотите использовать [`discord.ext.commands.Bot`][7], я бы сразу отдельно добавил еще и этот класс
```py
from discord.ext import commands
```

### Инициализация бота

Теперь создадим объект бота, который будет обрабатывать события и команды:

Из [документации][7] видим, что единственным обязательным аргументом при создании экземпляра класса является `command_prefix`.

Он принимает строку (`str`), по которой бот будет определять, то что сообщение является командой и обрабатывать его нужно именно как команду.

Помимо этого, выдадим боту намерения (`intents`), инструкция по настройке которых была [в начале][11].

*В качестве префикса команды укажем `!`, намерения нужно выдавать именно те, которые вы будете использовать, но на первое время можно выдать все, то есть `discord.Intents.all()`*

**Если у вас `discord.ext.commands.Bot`:**
```py
bot = commands.Bot(command_prefix='!', intents=discord.Intents.all())
```
**Если у вас `discord.Client`, то префикс указывать не нужно (класс не принимает такого аргумента):**
```py
bot = discord.Client(intents=discord.Intents.all())
```

---

### Основные обработчики событий

Теперь у нас есть объект `bot`, для которого нужно написать логику взаимодействия. 

В качестве обработчиков событий используются асинхронные (`async`) функции (`def`), помеченные декоратором `@bot.event`, где `bot` - название объекта вашего бота. Функция должна иметь название, строго как в документации - иначе событие просто не будет обработано.

Если коротко, то все, что делает декоратор `@bot.event` - это помещает написанную вами функцию в другую функцию из библиотеки `discord`, которая, в свою очередь, передает вашей функции какие-либо параметры. Поэтому, если не пометить функцию декоратором, `discord` не обратит на нее внимание и она не будет вызвана.

#### `async def on_ready()`

Первым делом, нужно удостовериться, что бот успешно запустился и готов к работе. В [списке событий][6] находим событие [`on_ready()`][12], которое вызывается **один раз** при запуске кода и обозначает то, что бот загрузился и готов к работе. 

Здесь нужно отметить, что в этой функции не следует размещать фрагменты кода, которые должны будут выполняться в дальнейшем, так как функция будет вызвана только один раз.
Поэтому в этой функции можно разместить какое-либо сообщение, о том, что бот запущен и, если есть работа с данными из файлов, то самое время их подгрузить. *В общем, выполнить все единоразовые процедуры*.

**Выглядеть это будет вот так:**
```py
@bot.event
async def on_ready():
  # сам по себе объект bot (discord.ext.commands.Bot) не содержит имени бота
  # зато содержит объект пользователя, которым он является
  # а вот объект пользователя уже хранит в себе имя
  print(f'{bot.user.name} запустился и готов к работе!')
```

#### `async def on_message(message)`

Добавим обработчик сообщений, чтобы получать вызов функции каждый раз, когда `bot` получает сообщение в ЛС или на сервере. 

В [списке событий][6] находим событие [`on_message(message)`][13], которое принимает обязательный аргумент `message`. Этот аргумент имеет тип `discord.Message` из которого вы можете получить текст сообщения, а также объекты автора сообщения, сервер, канал, вложения, реакции, упоминания, ссылку на сообщение и [много чего еще][14]

```py
@bot.event
async def on_message(message):
  print(f'Получено сообщение! Текст: {message.content}, Сервер: {message.guild}')
```

Здесь вы можете прописать любую логику взаимодействия. Хоть даже удалять все только что переданные обработчиком сообщения *(главное чтобы у бота были на то права)*.
Самое главное - задать функции аргумент, который будет принимать объект сообщения. Вы можете назвать его как хотите, например даже так: `async def on_message(soobshenie)`, главное чтобы он был.

Если аргумент не указать, то при вызове события нового сообщения, `discord-py` отправит в функцию `on_message()` аргумент, содержащий объект сообщения, но получит ошибку о том, что указанная функция не принимает аргументов и ничего работать не будет. Это равноценно созданию функции, которая считает 2 переданных в виде аргументов числа, но при это не принимает их.

#### Другие события

По аналогии с примерами, приведенными выше, можно создать обработчик любого другого события, предствленного в `discord-py`. Главное, чтобы совпадало название и принимаемые аргументы. 

Примеры других часто используемых событий:

[`on_raw_reaction_add(payload)`][15], [`on_raw_reaction_add(payload)`][16] - события добавления и удаления реакции с сообщения, соответствено. Из объекта [`payload`][17] вы можете получить сервер, сообщения и [прочую инфу][17]

[`on_member_join(member)`][18], [`on_member_remove(member)`][18] - события подключения и выхода участника с сервера, в качестве аргумента принимает объект участника из которого можно получить всю информацию о пользователе.

Остальное вы можете найти в [списке событий][6].

---

### Запуск бота

У вас уже есть объект бота и, вероятно, обработчики событий. Теперь бота нужно запустить.

При помощи токена, который нужно скопировать на странице бота, в [разделе приложений][1] вы можете авторизоваться в аккаунте бота.

Для этого у объекта `bot` нужно вызвать функцию [`run()`][19]:
```py
TOKEN = '' # здесь ваш токен
bot.run(TOKEN)
```
Данная строка должна всегда находиться в самом низу кода. После ее выполнения бот будет запущен и весь код, который находится ниже этой строки будет выполнен только после завершения работы бота.

Бот будет выполнять работу до дех пор, пока вы не завершите выполнение кода. Это означает, что если вы закроете консольное окно программы, то бот перестанет работать и обрабатывать какие-либо события.

---

В итоге должен получиться примерно такой код, посмотреть который можно [**здесь**][20].

Данный бот выводит сообщение при успешном запуске, а также подробную информацию о каждом полученном сообщении.

Для этого примера достаточно было бы простого бота [`discord.Client`][5], так как он обрабатывает только события. Но я наперед прописал в коде бота [`discord.ext.commands.Bot`][7], так как дальше в этот код мы будем добавлять обработку команд.

---

### Обработка отдельных команд

*Напоминаю, что для работы с командами, в качестве бота нужно использовать объект [`discord.ext.commands.Bot`][7], а не [`discord.Client`][5]!*

 - Команды бота, как и обработчики событий, являются асинхронными функциями (`async def`). 

 - Чтобы `discord-py` обнаружил команду в коде, функцию нужно пометить декоратором `@bot.command()`, где `bot` - название объекта вашего бота. 

 - **Скобки в декораторе `@bot.command()` обязательны**, в отличии от `@bot.event`, так как декторатор [`discord.ext.commands.Command()`][22] принимает необязательные аргументы.    Без скобок декоратор корректно работать не будет. **Подробнее про декораторы можно почитать [**выше**][21]*

 - В отличии от событий, функцию можно назвать как захочется - **название функции станет названием команды**.

 - **Любая** функция, являющаяся командой, должна принимать обязательный аргумент `ctx` *(можно назвать как угодно)*. Аргумент является контекстом ([`discord.ext.commands.Context`][22]) выполнения команды, из которого можно получить сервер, автора, сообщение, канал и др. информацию. При вызове команды, Контекст в функцию передает библиотека `discord-py`.


[1]: https://discord.com/developers/applications
[2]: https://i.stack.imgur.com/ZnOYm.png
[3]: https://i.stack.imgur.com/HZCQP.png
[4]: https://discordpy.readthedocs.io/en/stable/intents.html
[5]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=client#discord.Client
[6]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=event#discord-api-events
[7]: https://discordpy.readthedocs.io/en/stable/ext/commands/api.html?highlight=bot#discord.ext.commands.Bot
[8]: https://discordpy.readthedocs.io/en/stable/ext/commands/api.html?highlight=cog#discord.ext.commands.Cog
[9]: https://discord.com/developers/applications
[10]: https://github.com/denisnumb/discord-py-guide/blob/main/using_docs.md#%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE-%D0%BF%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8E-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B8-discord-py
[11]: https://github.com/denisnumb/discord-py-guide/blob/main/discord-py.md#%D0%BF%D1%80%D0%B5%D0%B6%D0%B4%D0%B5-%D1%87%D0%B5%D0%BC-%D0%BD%D0%B0%D1%87%D0%B0%D1%82%D1%8C
[12]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=event#discord.on_ready
[13]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=event#discord.on_message
[14]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=event#discord.Message
[15]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=on_raw_reaction_add#discord.on_raw_reaction_add
[16]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=on_raw_reaction_add#discord.on_raw_reaction_remove
[17]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=on_raw_reaction_add#discord.RawReactionActionEvent
[18]: https://discordpy.readthedocs.io/en/stable/api.html?highlight=on_raw_reaction_add#discord.on_member_join
[19]: https://discordpy.readthedocs.io/en/stable/ext/commands/api.html?highlight=bot#discord.ext.commands.Bot.run
[20]: https://github.com/denisnumb/discord-py-guide/blob/main/examples/events.py
[21]: https://github.com/denisnumb/discord-py-guide/blob/main/discord-py.md#%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5-%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B8-%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B9
[22]: https://discordpy.readthedocs.io/en/stable/ext/commands/api.html?highlight=command#command
[23]: https://discordpy.readthedocs.io/en/stable/ext/commands/api.html?highlight=context#discord.ext.commands.Context
